<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>In Browser Visualization</title>
    <link rel="stylesheet" href="styles.css">
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lil-gui@0.19.1/dist/lil-gui.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.3.0/math.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quaternion@1.5.1/quaternion.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/numeric@1.2.6/numeric-1.2.6.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stats.js@0.17.0/build/stats.min.js"></script>
    <script type="importmap">
        {
            "imports": {
              "three_engine/": "https://cdn.jsdelivr.net/gh/Apollo-Lab-Yale/apollo-three-engine/js/",
              "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
              "three/": "https://unpkg.com/three@0.160.0/"
            }
        }
    </script>
</head>
<body>
<div id="image-container">
    <img src="./assets/apollo-lab-logo.png" alt="Image 1">
    <button id="return-button">Return</button>
</div>
<div id="menu-container">
    <h1>Select a Robot</h1>
    <label for="robot-select">Choose a robot:</label>
    <select id="robot-select">
        <!-- Options will be populated dynamically -->
    </select>
    <button id="load-robot">Load Robot</button>
    <div id="menu-instructions">
        Instructions:
        <ul>
            <li>Select a robot from the dropdown menu.</li>
            <li>Click the "Load Robot" button to visualize the selected robot.</li>
            <li>Use the provided controls to interact with the robot and visualize various information.</li>
        </ul>
    </div>
</div>

<script>
    // adapted from:
    // https://stackoverflow.com/questions/39048654/how-to-enable-directory-indexing-on-github-pages
    // Fetch the list of robots from the GitHub API and populate the dropdown options
    document.addEventListener('DOMContentLoaded', async () => {
        const user = 'Apollo-Lab-Yale'; // Replace with your GitHub username
        const repo = 'apollo-robots-dir'; // Replace with your repository name
        const path = 'robots'; // Path to the robots directory
        const apiUrl = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;

        try {
            const response = await fetch(apiUrl);
            const data = await response.json();
            const select = document.getElementById('robot-select');

            data.forEach(file => {
                if (file.type === 'dir') {
                    const option = document.createElement('option');
                    option.value = file.name.toLowerCase().replace(/\s+/g, '-');
                    option.textContent = file.name;
                    select.appendChild(option);
                }
            });
        } catch (error) {
            console.error('Error fetching robot data:', error);
        }

        // Return button functionality
        document.getElementById('return-button').addEventListener('click', () => {
            location.reload();
        });
    });
</script>

<div id="visualization-container">
    <!-- Visualization content will go here -->
</div>
<script type="module">
    import {ThreeEngine} from 'three_engine/utils/utils_three.js';
    import {RobotFKSlidersVisualizer} from 'three_engine/utils/utils_kinematics.js';
    import {RobotFromPreprocessor} from 'three_engine/utils/utils_robot.js';
    // import {visualize_robot} from 'three_engine/utils/utils_robots_visualization.js';

    let engine = ThreeEngine.new_default_3d();
    const robots_dir = './robots';

    async function visualize_robot(engine, robots_dir, robot_name) {
        const robot_dir = `${robots_dir}/${robot_name}`;
        const [chainConfig, urdfConfig, meshConfig_stl, meshConfig, meshConfig_hull, meshConfig_convex_decomposition, shapesConfig] = await Promise.all([
            fetch(`${robot_dir}/chain_module/module.json`).then(response => response.json()),
            fetch(`${robot_dir}/urdf_module/module.json`).then(response => response.json()),
            fetch(`${robot_dir}/mesh_modules/plain_meshes_module/module.json`).then(response => response.json()),
            fetch(`${robot_dir}/mesh_modules/original_meshes_module/module.json`).then(response => response.json()),
            fetch(`${robot_dir}/mesh_modules/convex_hull_meshes_module/module.json`).then(response => response.json()),
            fetch(`${robot_dir}/mesh_modules/convex_decomposition_meshes_module/module.json`).then(response => response.json()),
            fetch(`${robot_dir}/link_shapes_modules/link_shapes_approximations_module/module.json`).then(response => response.json()),
        ]);

        let robot = new RobotFromPreprocessor(
            chainConfig,
            urdfConfig,
            meshConfig,
            meshConfig_stl,
            'stl',
            meshConfig_hull,
            meshConfig_convex_decomposition,
            //shapesConfig,
            `apollo-robots-dir/${robots_dir}`// robots_dir
        );

        robot.spawn_robot(engine);

        let visualizer = new RobotFKSlidersVisualizer(robot);
        engine.animation_loop(function() {
            visualizer.three_loop_function(engine);
        });
    }

    document.getElementById('load-robot').addEventListener('click', () => {
        const robot_name = document.getElementById('robot-select').value;
        document.getElementById('menu-container').style.display = 'none';
        document.getElementById('visualization-container').style.display = 'block';
        visualize_robot(engine, robots_dir, robot_name);
    });
</script>
</body>
</html>
